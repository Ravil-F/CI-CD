# Basic CI/CD


## Part 1. Настройка gitlab-runner

- Поднимем виртуальную машину Ubuntu Server 22.04 LTS:
    - если нужно обновить до нужной версии выполним следующие команды:\
        - lsb_release –a - узнать версию
        - sudo apt update
        - sudo apt upgrade
        - sudo apt dist-upgrade
        - sudo do-release-upgrade
        - и ждем, соглашаемся (ставим Y).
        - lsb_release –a - проверяем версию

- Скачай и установи на виртуальную машину gitlab-runner:
    - curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash:\
    ![Part_1](Part_1/1.png)

    - sudo apt-get install gitlab-runner (sudo apt-get install gitlab-runner=16.5.0 - установка определенной версии)\
    ![Part_1](Part_1/2.png)

- Запусти gitlab-runner и зарегистрируй его для использования в текущем проекте (DO6_CICD):\
    ![Part_1](Part_1/3.png)
    ![Part_1](Part_1/4.png)

- Для регистрации понадобятся URL и токен, которые можно получить на страничке задания на платформе:\
    ![Part_1](Part_1/5.png)


## Part 2. Сборка

- В файле gitlab-ci.yml добавь этап запуска сборки через мейк файл из проекта C2, этот файл помести в корневой каталог, и поставь точку перед именем файла. Файлы, полученные после сборки (артефакты), сохрани в произвольную директорию со сроком хранения 30 дней (не забываем установить make: sudo apt install cmake):\
    ![Part_2](Part_2/1.png)

    - Результат:\
    ![Part_2](Part_2/2.png)


## Part 3. Тест кодстайла

- Напиши этап для CI, который запускает скрипт кодстайла (clang-format - не забудь установить):\
    ![Part_3](Part_3/1.png)

- Результат положительный:\
    ![Part_3](Part_3/2.png)

- Сделаем ошибку в одном из файлов, чтобы не прошла проверка:\
    ![Part_3](Part_3/3.png)
    ![Part_3](Part_3/4.png)


## Part 4. Интеграционные тесты

- Напиши этап для CI, который запускает твои интеграционные тесты из того же проекта:
    - Запусти этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно:\
        ![Part_4](Part_4/1.png)
        ![Part_4](Part_4/2.png)
        ![Part_4](Part_4/3.png)
        ![Part_4](Part_4/4.png)
        

- Если тесты не прошли, то «зафейли» пайплайн. Добавим условия в наши тесты (exit 1):\
    - test_cat.sh:\
        ![Part_4](Part_4/5.png)
    - test_grep.sh:\
        ![Part_4](Part_4/6.png)

- Тесты не прошли, есть ошибки в тестах:\
    ![Part_4](Part_4/7.png)
    ![Part_4](Part_4/8.png)

- Исправим наши тесты, чтобы в них не было ошибок и посмотрим, что все проходит:\
    ![Part_4](Part_4/9.png)
    ![Part_4](Part_4/10.png)


## Part 5. Этап деплоя

- Подними вторую виртуальную машину Ubuntu Server 22.04 LTS:
    -  Создаем новую машину и связываем ее с первой:\
        ![Part_5](Part_5/1.png)
        ![Part_5](Part_5/2.png)

- Прокинем ssh ключ на вторую машину:\
    ![Part_5](Part_5/3.png)
    ![Part_5](Part_5/4.png)
    ![Part_5](Part_5/5.png)

- Дадим доступ к папку /usr/local/bin на второй машине:\
    ![Part_5](Part_5/6.png)

- Напиши этап для CD, который «разворачивает» проект на другой виртуальной машине:
    - напишем скрипт, где происходит копирование файлов, которые скомпилировались:\
    ![Part_5](Part_5/7.png)
    ![Part_5](Part_5/8.png)

- Запусти этот этап вручную при условии, что все предыдущие этапы прошли успешно:\
    ![Part_5](Part_5/9.png)

- Запустим в ручную и посмотрим на второй машине, те файлы которые должны скопироваться:\
    ![Part_5](Part_5/10.png)

- Посмотрим на второй машине, скопированные файлы:\
    ![Part_5](Part_5/11.png)


## Part 6. Дополнительно. Уведомления

- Настрой уведомления о успешном/неуспешном выполнении пайплайна через бота с именем «[твой nickname] DO6 CI/CD» в Telegram:\

    - используем в Telegram "Botfather"

    - Чтобы получить id бота, в браузере: https://api.telegram.org/bot7383376298:AAFI87Z5bREL0MZh4F7JrB0BKgSWhjZPYAI/getUpdates

    - напишем скрипт, который отравляет сообщения в  Telegram:\
    ![Part_6](Part_6/1.png)

    - допишем .gitlab-ci.yml, чтобы запускать скрипт:\
    ![Part_6](Part_6/2.png)

    - Посмотрим на результат, здесь должно придти сообщение, что все работает:\
    ![Part_6](Part_6/3.png)
    ![Part_6](Part_6/4.png)
    
    - Сделаем ошибки в тесте, и посмотрим какое сообщение придет:\
    ![Part_6](Part_6/5.png)
    ![Part_6](Part_6/6.png)

### Вся информация о gitlab есть на сайте https://docs.gitlab.com/